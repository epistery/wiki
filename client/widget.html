<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Wiki Agent Widget</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding: 1em;
      background: transparent;
    }
    .wiki-widget {
      display: flex;
      flex-direction: column;
      gap: 0.5em;
    }
    .wiki-widget-header {
      display: flex;
      align-items: center;
      gap: 0.5em;
    }
    .wiki-widget-icon {
      width: 24px;
      height: 24px;
    }
    .wiki-widget-title {
      font-weight: 600;
      font-size: 14px;
    }
    .wiki-widget-stats {
      font-size: 12px;
      color: #666;
    }
    .wiki-widget-recent {
      font-size: 12px;
    }
    .wiki-widget-recent a {
      color: #0066cc;
      text-decoration: none;
    }
    .wiki-widget-recent a:hover {
      text-decoration: underline;
    }
    .wiki-widget-link {
      font-size: 12px;
      margin-top: 0.5em;
    }
    .wiki-widget-link a {
      color: #0066cc;
      text-decoration: none;
    }
  </style>
</head>
<body>
  <div class="wiki-widget">
    <div class="wiki-widget-header">
      <svg class="wiki-widget-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
        <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
        <line x1="8" y1="6" x2="16" y2="6"/>
        <line x1="8" y1="10" x2="16" y2="10"/>
        <line x1="8" y1="14" x2="12" y2="14"/>
      </svg>
      <span class="wiki-widget-title">Wiki</span>
    </div>
    <div class="wiki-widget-stats" id="stats">Loading...</div>
    <div class="wiki-widget-recent" id="recent"></div>
    <div class="wiki-widget-link">
      <a href="/wiki/Home">Open Wiki</a>
    </div>
  </div>

  <script>
    async function loadWidget() {
      try {
        // Load status
        const statusResponse = await fetch('/agent/epistery/wiki/status');
        const status = await statusResponse.json();
        document.getElementById('stats').textContent = `${status.documentCount || 0} documents`;

        // Load recent documents
        const indexResponse = await fetch('/agent/epistery/wiki/index');
        const index = await indexResponse.json();

        const recent = index
          .filter(doc => doc.listed !== false)
          .sort((a, b) => new Date(b._modified) - new Date(a._modified))
          .slice(0, 5);

        if (recent.length > 0) {
          const recentHtml = recent.map(doc =>
            `<a href="/wiki/${encodeURIComponent(doc._id)}">${doc.title || doc._id}</a>`
          ).join(', ');
          document.getElementById('recent').innerHTML = 'Recent: ' + recentHtml;
        }
      } catch (error) {
        console.error('[wiki-widget] Error:', error);
        document.getElementById('stats').textContent = 'Unable to load';
      }
    }

    loadWidget();
  </script>
</body>
</html>
