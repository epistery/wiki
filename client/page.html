<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wiki</title>
  <link rel="stylesheet" href="/style/static.css">
  <script src="/script/common.js"></script>
  <style>
    .wiki-container {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    .wiki-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
      position: relative;
    }

    .wiki-header-bar {
      flex-shrink: 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--spacer) var(--spacer2);
      border-bottom: 1px solid var(--page-border);
      background: var(--bg-color);
    }

    .wiki-body {
      flex: 1;
      overflow-y: auto;
      padding: var(--spacer2);
    }

    .wiki-sidebar {
      width: 300px;
      flex-shrink: 0;
      background: var(--bg-color-quiet-d);
      border-left: 1px solid var(--page-border);
      overflow-y: auto;
      padding: var(--spacer2);
    }
    .wiki-header-actions {
      display: flex;
      gap: var(--spacerhalf);
      align-items: center;
    }

    .btn {
      padding: var(--spacerhalf) var(--spacer);
      border: 1px solid var(--page-border);
      border-radius: 4px;
      background: var(--bg-color);
      cursor: pointer;
      text-decoration: none;
      color: var(--text-color);
      font-size: 0.875em;
    }

    .btn:hover {
      background: var(--bg-color-d);
    }

    .btn-primary {
      background: var(--rust-mid);
      color: white;
      border-color: var(--rust-mid);
    }

    .btn-primary:hover {
      background: var(--rust-deep);
    }

    .wiki-content {
      max-width: 800px;
      line-height: 1.7;
      color: var(--text-color);
    }

    .wiki-content h1,
    .wiki-content h2,
    .wiki-content h3 {
      margin-top: var(--spacer2);
      margin-bottom: var(--spacer);
      color: var(--text-color-d);
    }

    .wiki-content h1:first-child {
      margin-top: 0;
    }

    .wiki-content p {
      margin-bottom: var(--spacer);
    }

    .wiki-content a {
      color: var(--rust-mid);
      text-decoration: none;
    }

    .wiki-content a:hover {
      color: var(--rust-deep);
      text-decoration: underline;
    }

    .wiki-content pre {
      background: var(--bg-color-quiet-d);
      padding: var(--spacer);
      overflow-x: auto;
      border-radius: 4px;
      margin: var(--spacer) 0;
    }

    .wiki-content code {
      background: var(--bg-color-quiet-d);
      padding: 0.2em 0.4em;
      border-radius: 3px;
      font-size: 0.9em;
      font-family: 'Courier New', monospace;
    }

    .wiki-content pre code {
      background: none;
      padding: 0;
    }

    .wiki-meta {
      margin-top: var(--spacer2);
      padding-top: var(--spacer);
      border-top: 1px solid var(--page-border);
      font-size: 0.875em;
      color: var(--text-color-quiet);
    }

    .wiki-breadcrumb {
      font-size: 0.9em;
      color: var(--text-color-quiet);
      display: flex;
      align-items: center;
      gap: var(--spacerhalf);
      flex: 1;
    }

    .wiki-breadcrumb a {
      color: var(--text-color-quiet);
      text-decoration: none;
    }

    .wiki-breadcrumb a:hover {
      color: var(--rust-mid);
      text-decoration: underline;
    }

    .wiki-breadcrumb-sep {
      color: var(--text-color-quiet);
    }
    /* Editor styles */
    .wiki-editor {
      display: none;
    }

    .wiki-editor.active {
      display: block;
    }

    .wiki-viewer.hidden {
      display: none;
    }

    .wiki-editor textarea {
      width: 100%;
      min-height: 500px;
      padding: var(--spacer);
      font-family: 'Courier New', monospace;
      font-size: 14px;
      border: 1px solid var(--page-border);
      border-radius: 4px;
      resize: vertical;
      background: var(--bg-color);
      color: var(--text-color);
    }

    .wiki-editor-toolbar {
      display: flex;
      gap: var(--spacer);
      margin-bottom: var(--spacer);
      align-items: center;
    }

    .wiki-editor-toolbar input,
    .wiki-editor-toolbar select {
      padding: var(--spacerhalf);
      font-size: 1em;
      border: 1px solid var(--page-border);
      border-radius: 4px;
      background: var(--bg-color);
      color: var(--text-color);
    }

    .wiki-editor-toolbar input {
      flex: 1;
    }

    .error {
      background: #ffe6e6;
      color: var(--status-error);
      padding: var(--spacer);
      border-radius: 4px;
      margin-bottom: var(--spacer);
      border: 1px solid var(--status-error);
    }

    .loading {
      text-align: center;
      padding: var(--spacer2);
      color: var(--text-color-quiet);
    }

    /* Sidebar index */
    .wiki-index ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .wiki-index li {
      margin: 0;
      padding: 0;
    }

    .wiki-index-item {
      display: flex;
      align-items: center;
      padding: var(--spacerthird) 0;
    }

    .wiki-index-toggle {
      width: 20px;
      height: 20px;
      border: none;
      background: none;
      cursor: pointer;
      padding: 0;
      margin-right: var(--spacerthird);
      font-size: 0.75em;
      color: var(--text-color-quiet);
      flex-shrink: 0;
    }

    .wiki-index-toggle:hover {
      color: var(--rust-mid);
    }

    .wiki-index-toggle.empty {
      visibility: hidden;
    }

    .wiki-index-link {
      color: var(--text-color);
      text-decoration: none;
      flex: 1;
      padding: var(--spacerthird) var(--spacerhalf);
      border-radius: 3px;
      font-size: 0.9em;
    }

    .wiki-index-link:hover {
      background: var(--bg-color-d);
      color: var(--rust-mid);
    }

    .wiki-index-link.active {
      background: var(--rust-light);
      color: white;
      font-weight: 500;
    }

    .wiki-index-children {
      margin-left: 1em;
      padding-left: 0.5em;
      border-left: 2px solid #ddd;
      display: none;
    }

    .wiki-index-children.expanded {
      display: block;
    }
  </style>
</head>
<body>
<header>
  <nav>
    <a href="/?home" class="logo">
      <img alt="logo" src="/image/epistery-logo-32.svg" class="logo-window">
    </a>
    <div class="nav-menu" id="nav-menu"></div>
  </nav>
</header>

<main class="wiki-container">
  <div class="wiki-main">
      <div class="wiki-header-bar">
        <div id="breadcrumb" class="wiki-breadcrumb"></div>
        <div class="wiki-header-actions">
          <button class="btn btn-primary" id="edit-btn-header" style="display: none;">Edit</button>
          <a href="/agent/epistery/wiki/admin" class="btn">Admin</a>
        </div>
      </div>

      <div class="wiki-body">
        <div id="error" class="error" style="display: none;"></div>

        <div id="loading" class="loading">Loading...</div>

        <div id="viewer" class="wiki-viewer" style="display: none;">
          <div class="wiki-content" id="doc-content"></div>
          <div class="wiki-meta" id="doc-meta"></div>
        </div>

        <div id="editor" class="wiki-editor">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacer2);">
            <h2>Editing: <span id="edit-doc-id"></span></h2>
            <div style="display: flex; gap: var(--spacerhalf);">
              <button class="btn" id="cancel-btn">Cancel</button>
              <button class="btn btn-primary" id="save-btn">Save</button>
            </div>
          </div>
          <div class="wiki-editor-toolbar">
            <input type="text" id="edit-title" placeholder="Document title">
            <select id="edit-parent">
              <option value="">(Root level)</option>
            </select>
            <select id="edit-visibility">
              <option value="public">Public</option>
              <option value="private">Private</option>
            </select>
          </div>
          <textarea id="edit-body" placeholder="Enter markdown content..."></textarea>
        </div>
      </div>
    </div>

    <div class="wiki-sidebar">
      <div class="wiki-index">
        <div id="index-tree"></div>
      </div>
    </div>
  </main>

  <script type="module">
    const API_BASE = '/agent/epistery/wiki';

    let currentDoc = null;
    let canEdit = false;
    let markupRenderer = null;
    let allDocs = [];

    // Initialize MarkUp renderer
    async function initMarkup() {
      if (!markupRenderer) {
        const MarkUp = await import(`${API_BASE}/MarkUp.mjs`).then(m => m.default);
        markupRenderer = new MarkUp({ basePath: API_BASE });
        await markupRenderer.init();
      }
      return markupRenderer;
    }

    // Get doc ID from URL path
    function getDocId() {
      const path = window.location.pathname;
      const match = path.match(/\/agent\/epistery\/wiki\/(.+)/);
      return match ? decodeURIComponent(match[1]) : 'Home';
    }

    // Build and render the index tree
    function renderIndexTree() {
      const currentDocId = getDocId();

      // Build parent-child map: map parent ID to list of children
      const childrenMap = new Map();

      allDocs.forEach(doc => {
        const parentId = doc._pid || '';
        if (!childrenMap.has(parentId)) {
          childrenMap.set(parentId, []);
        }
        childrenMap.get(parentId).push(doc);
      });

      // Get all root documents (those with _pid === '' or no _pid)
      const rootDocs = childrenMap.get('') || [];

      // Render tree recursively
      function renderNode(doc) {
        const children = childrenMap.get(doc._id) || [];
        const hasChildren = children.length > 0;
        const isActive = doc._id === currentDocId;

        const li = document.createElement('li');

        const itemDiv = document.createElement('div');
        itemDiv.className = 'wiki-index-item';

        // Toggle button
        const toggle = document.createElement('button');
        toggle.className = 'wiki-index-toggle' + (hasChildren ? '' : ' empty');
        toggle.textContent = hasChildren ? '▶' : '';
        toggle.setAttribute('aria-label', 'Toggle children');

        // Link
        const link = document.createElement('a');
        link.href = API_BASE + '/' + encodeURIComponent(doc._id);
        link.className = 'wiki-index-link' + (isActive ? ' active' : '');
        link.textContent = doc.title || doc._id;

        itemDiv.appendChild(toggle);
        itemDiv.appendChild(link);
        li.appendChild(itemDiv);

        // Children container
        if (hasChildren) {
          const childrenUl = document.createElement('ul');
          childrenUl.className = 'wiki-index-children';

          // Auto-expand Home and any ancestor of current doc
          if (doc._id === 'Home') {
            childrenUl.classList.add('expanded');
            toggle.textContent = '▼';
          }

          children
            .sort((a, b) => (a.title || a._id).localeCompare(b.title || b._id))
            .forEach(child => {
              childrenUl.appendChild(renderNode(child));
            });

          li.appendChild(childrenUl);

          // Toggle handler
          toggle.addEventListener('click', (e) => {
            e.preventDefault();
            const isExpanded = childrenUl.classList.toggle('expanded');
            toggle.textContent = isExpanded ? '▼' : '▶';
          });
        }

        return li;
      }

      const tree = document.createElement('ul');
      rootDocs
        .sort((a, b) => (a.title || a._id).localeCompare(b.title || b._id))
        .forEach(doc => {
          tree.appendChild(renderNode(doc));
        });

      document.getElementById('index-tree').innerHTML = '';
      document.getElementById('index-tree').appendChild(tree);

      // Auto-expand to show current document (in addition to Home)
      expandToDocument(currentDocId);
    }

    // Expand tree to show a specific document
    function expandToDocument(docId) {
      const doc = allDocs.find(d => d._id === docId);
      if (!doc) return;

      // Build path to root
      const path = [docId];
      let current = doc;
      while (current._pid) {
        path.unshift(current._pid);
        current = allDocs.find(d => d._id === current._pid);
        if (!current) break;
      }

      // Expand all parents
      path.forEach(id => {
        const link = document.querySelector(`.wiki-index-link[href="${API_BASE}/${encodeURIComponent(id)}"]`);
        if (link) {
          const item = link.closest('li');
          const childrenUl = item?.querySelector('.wiki-index-children');
          const toggle = item?.querySelector('.wiki-index-toggle');
          if (childrenUl && toggle) {
            childrenUl.classList.add('expanded');
            toggle.textContent = '▼';
          }
        }
      });

      // Scroll active document into view
      const activeLink = document.querySelector('.wiki-index-link.active');
      if (activeLink) {
        activeLink.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
      }
    }

    // Load index data
    async function loadIndexData() {
      try {
        const response = await fetch(`${API_BASE}/index`);
        allDocs = await response.json();
        renderIndexTree();
      } catch (error) {
        console.error('[wiki] Failed to load index:', error);
      }
    }

    // Load and display document
    async function loadDocument(docId) {
      document.getElementById('loading').style.display = 'block';
      document.getElementById('viewer').style.display = 'none';
      document.getElementById('editor').classList.remove('active');
      document.getElementById('error').style.display = 'none';

      try {
        const response = await fetch(`${API_BASE}/${encodeURIComponent(docId)}`, {
          headers: { 'Accept': 'application/json' }
        });

        if (!response.ok) {
          throw new Error(`Failed to load: ${response.status}`);
        }

        currentDoc = await response.json();

        // New document - server returns template with _new flag and _pid from cookie
        if (currentDoc._new) {
          showEditor();
          return;
        }

        await renderDocument();

      } catch (error) {
        showError(error.message);
      }
    }

    // Build breadcrumb trail
    function renderBreadcrumb() {
      const breadcrumb = document.getElementById('breadcrumb');

      if (!currentDoc) {
        breadcrumb.innerHTML = '';
        return;
      }

      // Build path from current doc to root
      const path = [currentDoc];
      const visited = new Set([currentDoc._id]);

      // Walk up the parent chain using the index data
      let parentId = currentDoc._pid;
      while (parentId && parentId !== '' && !visited.has(parentId)) {
        const parent = allDocs.find(d => d._id === parentId);
        if (!parent) break;

        path.unshift(parent);
        visited.add(parent._id);
        parentId = parent._pid;
      }

      // Always prepend Home if we're not already on Home and Home exists
      const home = allDocs.find(d => d._id === 'Home');
      if (currentDoc._id !== 'Home' && home && path[0]._id !== 'Home') {
        path.unshift(home);
      }

      // Render breadcrumb
      const parts = path.map((doc, i) => {
        if (i === path.length - 1) {
          // Last item (current page) - no link
          return `<span>${escapeHtml(doc.title || doc._id)}</span>`;
        } else {
          return `<a href="${API_BASE}/${encodeURIComponent(doc._id)}">${escapeHtml(doc.title || doc._id)}</a>`;
        }
      });

      breadcrumb.innerHTML = parts.join(' <span class="wiki-breadcrumb-sep">/</span> ');
    }

    // Render document
    async function renderDocument() {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('viewer').style.display = 'block';

      // Render breadcrumb
      renderBreadcrumb();

      // Update index tree to highlight current doc
      renderIndexTree();

      // Render markdown with WikiWord processing
      const markup = await initMarkup();
      const html = await markup.render(currentDoc.body || '', { _pid: currentDoc._pid });
      const contentEl = document.getElementById('doc-content');
      contentEl.innerHTML = html;

      // Post-process for Mermaid diagrams
      await markup.renderMermaidDiagrams(contentEl);

      // Meta
      let meta = [];
      if (currentDoc._modified) {
        meta.push('Modified: ' + new Date(currentDoc._modified).toLocaleString());
      }
      if (currentDoc.visibility && currentDoc.visibility !== 'public') {
        meta.push('Visibility: ' + currentDoc.visibility);
      }
      document.getElementById('doc-meta').innerHTML = meta.join(' | ');

      // Check if user can edit (try a HEAD or just show button and let save fail)
      document.getElementById('edit-btn-header').style.display = 'inline-block';
      canEdit = true;

      // Wiki links already use the correct path format from MarkUp renderer
    }

    // Show editor
    function showEditor() {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('viewer').style.display = 'none';
      document.getElementById('viewer').classList.add('hidden');
      document.getElementById('editor').classList.add('active');

      document.getElementById('edit-doc-id').textContent = currentDoc._id;
      document.getElementById('edit-title').value = currentDoc.title || currentDoc._id;
      document.getElementById('edit-body').value = currentDoc.body || '';
      document.getElementById('edit-visibility').value = currentDoc.visibility || 'public';

      // Expand tree to show parent (for new documents)
      if (currentDoc._pid) {
        expandToDocument(currentDoc._pid);
      }

      // Populate parent dropdown
      const parentSelect = document.getElementById('edit-parent');
      const rootOption = document.createElement('option');
      rootOption.value = '';
      rootOption.textContent = '(Root level)';
      rootOption.selected = !currentDoc._pid || currentDoc._pid === '';
      parentSelect.innerHTML = '';
      parentSelect.appendChild(rootOption);

      allDocs
        .filter(d => d._id !== currentDoc._id) // Don't allow setting self as parent
        .sort((a, b) => (a.title || a._id).localeCompare(b.title || b._id))
        .forEach(doc => {
          const option = document.createElement('option');
          option.value = doc._id;
          option.textContent = doc.title || doc._id;
          option.selected = doc._id === currentDoc._pid;
          parentSelect.appendChild(option);
        });

      // Force the select to update its value
      if (currentDoc._pid) {
        parentSelect.value = currentDoc._pid;
      }
    }

    // Hide editor
    function hideEditor() {
      document.getElementById('editor').classList.remove('active');
      document.getElementById('viewer').classList.remove('hidden');
      document.getElementById('viewer').style.display = 'block';
    }

    // Save document
    async function saveDocument() {
      const doc = {
        title: document.getElementById('edit-title').value,
        body: document.getElementById('edit-body').value,
        _pid: document.getElementById('edit-parent').value,
        visibility: document.getElementById('edit-visibility').value
      };

      try {
        const response = await fetch(`${API_BASE}/${encodeURIComponent(currentDoc._id)}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(doc)
        });

        if (!response.ok) {
          const error = await response.json().catch(() => ({}));
          throw new Error(error.error || `Save failed: ${response.status}`);
        }

        currentDoc = await response.json();
        hideEditor();
        await renderDocument();

        // Reload index to reflect new document
        await loadIndexData();

      } catch (error) {
        showError('Save failed: ' + error.message);
      }
    }

    // Show error
    function showError(message) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('error').textContent = message;
      document.getElementById('error').style.display = 'block';
    }

    // Escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Event listeners
    document.getElementById('edit-btn-header').addEventListener('click', showEditor);
    document.getElementById('cancel-btn').addEventListener('click', () => {
      if (currentDoc._new) {
        window.location.href = API_BASE + '/Home';
      } else {
        hideEditor();
      }
    });
    document.getElementById('save-btn').addEventListener('click', saveDocument);

    // Initial load
    (async () => {
      await loadIndexData();
      await loadDocument(getDocId());
    })();
  </script>
</body>
</html>
